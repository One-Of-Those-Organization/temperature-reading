<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temperature Reader AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='if_ukdc_hd.png') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"/>
    <style>
        .cropper-wrapper { height: 400px; background: #e5e7eb; overflow: hidden; }
        #imageSource { display: block; max-width: 100%; }
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: bold; }
        .tab-inactive { color: #6b7280; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen py-10">

    <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg">

        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Temperature Reader</h1>
        <p class="text-center text-gray-500 mb-8">Pilih sumber gambar, crop area angka, dan proses dengan AI.</p>

        <div class="flex border-b border-gray-300 mb-6">
            <button onclick="setTab('upload')" id="btn-tab-upload" class="flex-1 py-3 text-lg transition tab-active">
                ðŸ“‚ Upload File
            </button>
            <button onclick="setTab('camera')" id="btn-tab-camera" class="flex-1 py-3 text-lg transition tab-inactive">
                ðŸ“· Live Camera
            </button>
        </div>

        <div id="panel-upload" class="mb-4">
            <label class="block mb-2 text-sm font-medium text-gray-700">Ambil dari Galeri/File</label>
            <input type="file" id="fileInput" accept="image/*" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 p-2.5">
        </div>

        <div id="panel-camera" class="hidden mb-4 text-center">
            <div class="relative inline-block w-full max-w-lg bg-black rounded-lg overflow-hidden shadow-md">
                <video id="videoElement" autoplay playsinline class="w-full"></video>
                <canvas id="canvasElement" class="hidden"></canvas>
            </div>
            <div class="mt-3">
                <button onclick="takeSnapshot()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition transform hover:scale-105">
                    Capture
                </button>
            </div>
        </div>

        <div class="cropper-wrapper rounded-lg border-2 border-dashed border-gray-300 relative flex justify-center items-center mb-6">
            <img id="imageSource" class="hidden">
            <div id="placeholder-text" class="absolute text-gray-400">Preview gambar akan muncul di sini</div>
        </div>

        <div id="cropType" class="w-full mb-4">
            <button
                    onclick="resetCropper()"
                    class="hidden w-full flex items-center justify-center gap-2 px-4 py-2
               text-sm font-semibold text-red-600
               bg-red-50 border border-red-200
               hover:bg-red-100 hover:border-red-300
               transition shadow-sm" disabled
            >
                ðŸ”„ Set Ulang Area Crop
            </button>
        </div>

        <div id="cropControls" class="hidden flex justify-center gap-4 mb-6">
            <button onclick="cropImage('setpoint')" class=" w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded shadow">
                1. Ambil Setpoint
            </button>
            <button onclick="cropImage('airtemp')" class="w-full bg-rose-600 hover:bg-rose-700 text-white font-medium py-2 px-4 rounded shadow">
                2. Ambil Air Temp
            </button>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-gray-50 p-3 rounded border border-gray-200 text-center">
                <p class="text-xs font-bold text-indigo-600 mb-2">Preview Setpoint</p>
                <div class="h-24 flex justify-center items-center overflow-hidden bg-white rounded">
                    <img id="preview-setpoint" class="h-full object-contain hidden">
                    <span id="txt-setpoint" class="text-xs text-gray-400">Kosong</span>
                </div>
            </div>
            <div class="bg-gray-50 p-3 rounded border border-gray-200 text-center">
                <p class="text-xs font-bold text-rose-600 mb-2">Preview Air Temp</p>
                <div class="h-24 flex justify-center items-center overflow-hidden bg-white rounded">
                    <img id="preview-airtemp" class="h-full object-contain hidden">
                    <span id="txt-airtemp" class="text-xs text-gray-400">Kosong</span>
                </div>
            </div>
        </div>

        <button id="btnProcess" onclick="sendData()" disabled
            class="w-full py-4 bg-gray-300 text-gray-500 font-bold rounded-xl text-lg shadow-sm cursor-not-allowed transition">
            Lengkapi Setpoint & Air Temp
        </button>

        <div id="resultBox" class="hidden mt-6 bg-white border border-green-200 p-6 rounded-xl shadow-inner text-center">
            <h3 class="text-lg font-bold text-gray-700 mb-4">Hasil Pembacaan AI</h3>
            <div id="resultContent" class="space-y-2"></div>
        </div>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script>
        // Global Variables
        let cropper;
        let cropLocked = false;
        let currentSource = 'upload';
        let stream = null;
        let autoInterval = null;

        // Images Crop Data (Base64)
        let cropData = {
            setpoint: null,
            airtemp: null
        };

        // Coordinates of Crop Areas
        let cropCoords = {
            setpoint: null,
            airtemp: null
        };

        // DEBUG LOG
        console.log("Current Crop Data:", cropData);
        console.log("Current Crop Coords:", cropCoords);

        // DOM Elements
        const imageElement = document.getElementById('imageSource');
        const fileInput = document.getElementById('fileInput');
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvasElement');
        const btnProcess = document.getElementById('btnProcess');

        // TAB CONTOL
        function setTab(mode) {
            currentSource = mode;

            // Stop Auto Capture if changing tab
            stopAutoCapture();

            // UI Toggle
            document.getElementById('panel-upload').classList.toggle('hidden', mode !== 'upload');
            document.getElementById('panel-camera').classList.toggle('hidden', mode !== 'camera');

            // Style Tab
            document.getElementById('btn-tab-upload').className = mode === 'upload' ? "flex-1 py-3 text-lg transition tab-active" : "flex-1 py-3 text-lg transition tab-inactive";
            document.getElementById('btn-tab-camera').className = mode === 'camera' ? "flex-1 py-3 text-lg transition tab-active" : "flex-1 py-3 text-lg transition tab-inactive";

            if (mode === 'camera') startCamera();
            else stopCamera();
        }

        // ==========================================================================
        // ============================== CAMERA LOGIC ==============================
        // ==========================================================================
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
            } catch (err) {
                alert("Failed to Access Camera: " + err);
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
        }

        // ==========================================================================
        // ============================ SNAPSHOT LOGIC ==============================
        // ==========================================================================

        function takeSnapshot() {
            if (!stream) {
                alert("Camera not started yet!");
                return;
            }

            // Image from video to canvas
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            // Take data from canvas
            const dataUrl = canvas.toDataURL('image/jpeg');

            // Load Original File Base64
            originalFileBase64 = dataUrl;

            // Setup cropper + auto crop jika koordinat lama ada
            setupCropper(dataUrl, true);
        }

        // ==========================================================================
        // ============================ CROPPER LOGIC ===============================
        // ==========================================================================
        let originalFileBase64 = null;

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            console.log("Selected file:", file);
            if (file) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    originalFileBase64 = evt.target.result;
                    console.log("Loaded file base64:", originalFileBase64);

                    // Uncomment this if want to reset crop data on new upload
                    // cropData = {
                    //     setpoint: null,
                    //     airtemp: null
                    // }

                    // Initialize Cropper + auto crop dari koordinat lama jika ada
                    setupCropper(originalFileBase64, true);
                };
                reader.readAsDataURL(file);
            } else {
                alert("No file selected");
            }
        });

        // Lock Crop UI after both crops are set
        function lockCropUI(){
            cropLocked = true;

            // Disable Set New Crop Button
            document.querySelectorAll('#cropControls button').forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            });

            // Enable Reset Crop Button
            const resetBtn = document.querySelector('#cropType button');
            resetBtn.classList.remove('hidden');
            resetBtn.disabled = false;
        }

        function resetCropper() {
            if (!originalFileBase64) {
                alert("Tidak ada gambar untuk di-reset");
                return;
            }

            console.log("Before Reset:", originalFileBase64);

            // Destroy existing cropper
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }

            // Unlock UI
            cropLocked = false;

            // Clear crop coords
            cropCoords = {
                setpoint: null,
                airtemp: null
            };

            // Clear crop data
            cropData = {
                setpoint: null,
                airtemp: null
            };

            // Reset preview
            ['setpoint', 'airtemp'].forEach(type => {
                const img = document.getElementById(`preview-${type}`);
                const txt = document.getElementById(`txt-${type}`);
                img.src = '';
                img.classList.add('hidden');
                txt.classList.remove('hidden');
                txt.textContent = "Kosong";
            });

            // Hide reset button
            document.querySelector('#cropType button').classList.add('hidden');

            // Enable crop buttons
            document.querySelectorAll('#cropControls button').forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            });

            // Disable process button until new crops are set
            btnProcess.disabled = true;
            btnProcess.innerHTML = "Lengkapi Setpoint & Air Temp";

            // Re-initialize cropper without applying old coords
            setupCropper(originalFileBase64, false);
            console.log("Init cropper after reset coords: ", originalFileBase64)
        }

        // Setup the CropperJS instance
        function setupCropper(imageUrl, applyOldCoords = false) {
            // Hancurkan cropper lama jika ada
            if (cropper) cropper.destroy();

            // Set image dan tampilkan
            imageElement.src = imageUrl;
            imageElement.classList.remove('hidden');
            document.getElementById('placeholder-text').classList.add('hidden');
            document.querySelector('#cropType button').classList.remove('hidden');
            document.getElementById('cropControls').classList.remove('hidden');
            document.getElementById('cropControls').classList.add('flex');

            // Set Timeout every 100ms to ensure image is loaded
            setTimeout(() => {
                // Call CropperJS
                cropper = new Cropper(imageElement, {
                    viewMode: 1,
                    autoCropArea: 0.6,
                    background: false,
                    ready() {
                        // Check only if need to apply old coords
                        if (applyOldCoords) {
                            // Auto crop from old coords if available
                            ['setpoint', 'airtemp'].forEach(type => {
                                // Get saved coords if not available, skip
                                const coords = cropCoords[type];
                                if (!coords) return;

                                // Don't overwrite if already cropped
                                if (cropData[type]) return;

                                // Append crop area
                                const canvasCrop = cropper.getCroppedCanvas({
                                    x: coords.x,
                                    y: coords.y,
                                    width: coords.width,
                                    height: coords.height,
                                    fillColor: '#fff'
                                });

                                // Save BASE64 IMAGE
                                cropData[type] = canvasCrop.toDataURL('image/jpeg', 0.9);

                                // Set preview
                                const previewImg = document.getElementById(`preview-${type}`);
                                const previewTxt = document.getElementById(`txt-${type}`);
                                previewImg.src = cropData[type];
                                previewImg.classList.remove('hidden');
                                previewTxt.classList.add('hidden');
                            });

                            // If there are already both crops, lock the UI
                            if (cropData.setpoint || cropData.airtemp) {
                                lockCropUI();
                                btnProcess.disabled = false;
                                setupProcessButton();
                            }
                        }
                    }
                });
            }, 100);
        }

        // Setup Process Button based on mode
        function setupProcessButton() {
            if (currentSource === 'camera') {
                btnProcess.innerHTML = "MULAI AUTO CAPTURE (5 MENIT)";
                btnProcess.onclick = startAutoCapture;
                btnProcess.className = "w-full py-4 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl shadow-lg transition cursor-pointer";
            } else { // mode upload
                btnProcess.innerHTML = "PROSES DATA SEKARANG";
                btnProcess.onclick = () => sendData(false);
                btnProcess.className = "w-full py-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg transition cursor-pointer";
            }
        }

        // Crop Image Function and Store Data
        function cropImage(type) {
            if (!cropper) {
                alert("Please load an image first.");
                return;
            }

            // Send alert if crop is locked and clicked the set button
            if (cropLocked){
                alert("Crop areas are locked. Please reset to change.");
                return;
            }

            // Get Cropped Canvas
            const canvasCrop = cropper.getCroppedCanvas({
                maxWidth: 800,
                fillColor: '#fff'
            });

            console.log("cropImage Data: ", canvasCrop);

            // If failed to crop
            if (!canvasCrop) {
                alert("Gagal melakukan crop.");
                return;
            }

            // 1. Save BASE64 IMAGE
            cropData[type] = canvasCrop.toDataURL('image/jpeg', 0.9);

            console.log("cropImage Base64: ", cropData[type]);

            // 2. Save CROP COORDINATES
            // This saves x, y, width, height of the cropped area
            cropCoords[type] = cropper.getData();

            console.log("cropImage Coords: ", cropCoords[type]);

            // 3. Update UI Preview
            const previewImg = document.getElementById(`preview-${type}`);
            const previewTxt = document.getElementById(`txt-${type}`);
            previewImg.src = cropData[type];
            previewImg.classList.remove('hidden');
            previewTxt.classList.add('hidden');

            checkReady();
        }

        // ==========================================================================
        // ========================= PROCESS BUTTON LOGIC ===========================
        // ==========================================================================

        function checkReady() {
            if (cropData.setpoint && cropData.airtemp) {
                lockCropUI();
                // If mode camera -> Then Auto Capture button
                if (currentSource === 'camera') {
                    btnProcess.disabled = false;
                    btnProcess.innerHTML = "MULAI AUTO CAPTURE (5 MENIT)";
                    btnProcess.onclick = startAutoCapture;
                    btnProcess.className = "w-full py-4 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl shadow-lg transition cursor-pointer";
                }
                // If mode upload -> Then normal process button
                else {
                    btnProcess.disabled = false;
                    btnProcess.innerHTML = "PROSES DATA SEKARANG";
                    btnProcess.onclick = () => sendData(false); // Pakai arrow function biar parameter jelas
                    btnProcess.className = "w-full py-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg transition cursor-pointer";
                }
            }
        }

        // Auto Capture Logic
        function startAutoCapture() {
            // Make sure camera is running and crop coords are set
            if (!stream || !cropCoords.setpoint || !cropCoords.airtemp) {
                alert("Pastikan kamera nyala dan kedua area crop sudah ditentukan!");
                return;
            }

            // Change Button to Stop
            btnProcess.innerHTML = "STOP AUTO CAPTURE (Sedang Berjalan...)";
            btnProcess.className = "w-full py-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl animate-pulse cursor-pointer";
            btnProcess.onclick = stopAutoCapture;

            console.log("Auto Capture dimulai...");

            // Run first process immediately
            processAutoFrame();

            // Set interval 5 menit (300000 ms)
            autoInterval = setInterval(processAutoFrame, 300000);
        }

        // Stop Auto Capture Logic
        function stopAutoCapture() {
            if (autoInterval) {
                clearInterval(autoInterval);
                autoInterval = null;
                console.log("Auto Capture berhenti.");
            }
            // Reset Button
            if (currentSource === 'camera' && cropData.setpoint) setupProcessButton();
        }

        // Process Auto Frame from Video
        function processAutoFrame() {
            if(video.videoWidth === 0 || video.videoHeight === 0) return;

            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            const ctx = tempCanvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            // Auto Crop based on saved coordinates
            cropData.setpoint = cropFromCanvas(tempCanvas, cropCoords.setpoint);
            cropData.airtemp = cropFromCanvas(tempCanvas, cropCoords.airtemp);

            // Update preview
            document.getElementById('preview-setpoint').src = cropData.setpoint;
            document.getElementById('preview-airtemp').src = cropData.airtemp;

            // Send Data to Server
            sendData(true);

            console.log("[AUTO FRAME] coords:", cropCoords);
        }

        // Helper: Crop from Canvas based on coordinates
        function cropFromCanvas(sourceCanvas, coords) {
            const destCanvas = document.createElement('canvas');
            destCanvas.width = coords.width;
            destCanvas.height = coords.height;
            const ctx = destCanvas.getContext('2d');

            ctx.drawImage(
                sourceCanvas,
                coords.x, coords.y, coords.width, coords.height,
                0, 0, coords.width, coords.height
            );

            return destCanvas.toDataURL('image/jpeg', 0.9);
        }

        // Send Data to Server
        async function sendData(isAuto = false) {
            const resultBox = document.getElementById('resultBox');

            // Make sure crop coords are set
            if (!cropCoords.setpoint || !cropCoords.airtemp) {
                alert("Crop area belum ditentukan. Silakan set crop dulu.");
                return;
            }

            // Send Config First
            await setConfig();

            // If manual mode, disable button and show processing text
            if (!isAuto) {
                btnProcess.disabled = true;
                btnProcess.innerHTML = "Sedang Memproses...";
            }

            if (!originalFileBase64) {
                alert("Image source is empty!");
                return;
            }

            try {
                const response = await fetch('/api/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        "image": originalFileBase64,
                        "source": currentSource,
                    })
                });

                console.log("Fetch /api/process response:", response);

                const json = await response.json();

                if (json.status !== 0) {
                    if(!isAuto) alert(json.statusText || "Gagal memproses data");
                    console.error("Process API Error:", json.statusText || json.message);
                    return;
                }

                resultBox.classList.remove('hidden');

                const logTime = new Date().toLocaleTimeString();

                // Show Result
                document.getElementById('resultContent').innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <p class="text-xs font-bold text-gray-500 uppercase">Setpoint</p>
                            <p class="text-4xl font-mono font-bold text-blue-700">${json.data.setpoint_code}</p>
                        </div>
                        <div class="p-4 bg-red-50 rounded-lg border border-red-200">
                            <p class="text-xs font-bold text-gray-500 uppercase">Air Temp</p>
                            <p class="text-4xl font-mono font-bold text-red-700">${json.data.air_temperature}</p>
                        </div>
                    </div>
                    <div class="mt-4 text-sm text-gray-500">
                        <p>Data tersimpan (Update: ${logTime})</p>
                        <p class="text-xs mt-1 text-gray-400">Timestamp Server: ${json.data.timestamp}</p>
                    </div>
                `;

                // Re-enable button if manual
                if (!isAuto) {
                    btnProcess.innerHTML = "Selesai (Klik untuk Kirim Lagi)";
                    btnProcess.disabled = false;
                }

            } catch (err) {
                console.error("Fetch /api/process failed:", err);
                if (!isAuto) {
                    btnProcess.disabled = false;
                    btnProcess.innerHTML = "Gagal Koneksi - Coba Lagi";
                }
            }
        }

        // Set New Coord and Send to Backend
        async function setConfig() {
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image: originalFileBase64,                        // Base64 image
                        setpoint_crop_image: cropData.setpoint,           // Base64 cropped setpoint
                        airtemp_crop_image: cropData.airtemp,             // Base64 cropped airtemp
                        region: [cropCoords.setpoint, cropCoords.airtemp] // Array of crop coordinates
                    })
                });

                const json = await response.json();

                if (json.status !== 0) {
                    alert("Gagal menyimpan konfigurasi: " + (json.message || "Unknown error"));
                    return;
                }

                console.log("Konfigurasi berhasil disimpan.");
            } catch (err) {
                console.error(err);
                alert("Gagal koneksi ke server.");
            }
        }

        // Load Config from Backend
        async function loadConfig() {
            try {
                const response = await fetch('/api/state');
                const json = await response.json();

                if (json.status !== 0) {
                    console.warn("Gagal mengambil konfigurasi:", json.message);
                    return;
                }

                const regions = json.regions;
                if (!regions || regions.length !== 2) return;

                cropCoords.setpoint = regions[0];
                cropCoords.airtemp = regions[1];

                if (json.crop_setpoint) cropData.setpoint = json.crop_setpoint;
                if (json.crop_airtemp) cropData.airtemp = json.crop_airtemp;

                if (cropData.setpoint) {
                    const previewSetpoint = document.getElementById('preview-setpoint');
                    previewSetpoint.src = cropData.setpoint;
                    previewSetpoint.classList.remove('hidden');
                    document.getElementById('txt-setpoint').classList.add('hidden');
                }

                if (cropData.airtemp) {
                    const previewAir = document.getElementById('preview-airtemp');
                    previewAir.src = cropData.airtemp;
                    previewAir.classList.remove('hidden');
                    document.getElementById('txt-airtemp').classList.add('hidden');
                }

                if (json.image) {
                    imageElement.src = `data:image/jpeg;base64,${json.image}`;
                    imageElement.classList.remove('hidden');
                    document.getElementById('placeholder-text').classList.add('hidden');

                    if (cropper) cropper.destroy();

                    cropper = new Cropper(imageElement, {
                        viewMode: 1,
                        autoCropArea: 0.6,
                        background: false,
                        ready() {
                            btnProcess.disabled = false;
                            btnProcess.innerHTML = "PROSES DATA SEKARANG";
                            btnProcess.onclick = () => sendData(false);
                        }
                    });
                }

            } catch (err) {
                console.error("Load config error:", err);
            }
        }

        // Load config on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadConfig();
        });

    </script>
</body>
</html>